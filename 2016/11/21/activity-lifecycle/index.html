
<!DOCTYPE html>
<html lang="null" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Satan&#39;Fu</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    
    <meta name="description" content="起因最近在搞公司的用户行为跟踪系统的时候碰到要统计用户在Activity的停留时间，然后就想到了在生命周期里面添加时间记录。在每个Activity里面重写生命周期函数添加时间记录？太麻烦了吧。写个B,"> 
    <meta name="author" content="Satan&#39;Fu"> 
    <link rel="alternative" href="atom.xml" title="Satan&#39;Fu" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link rel="stylesheet" href="/css/diaspora.css">

</head>
<body class="loading">
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">Activity生命周期监听</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>
    <div class="section">
        <div class="article">
    <div>
        <h1 class="title">Activity生命周期监听</h1>
        <div class="stuff">
            <span>十一月 21, 2016</span>
        </div>
        <div class="content markdown">
            <h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>最近在搞公司的用户行为跟踪系统的时候碰到要统计用户在Activity的停留时间，然后就想到了在生命周期里面添加时间记录。在每个Activity里面重写生命周期函数添加时间记录？太麻烦了吧。写个BaseActivity，在BaseActivity里面做时间记录？嗯，还行。还有么有更简便的方式。有啊，在Application里面调用registerActivityLifecycleCallbacks方法就可以监听所有Activity的生命周期，问题妥妥的搞定了。当时我在公司接触的项目都是4.0以上的了，所以也没考虑那么多。问题搞定了，是骡子是马来出来溜溜就知道了。然后领导就接入到公司一个比较旧的项目里面，然后过几天我就懵逼了，全都是registerActivityLifecycleCallbacks报的错误。当时表情是这样的</p>
<p><img src="http://ww2.sinaimg.cn/large/8a7693bbgw1f9zu6lj0xzj20b40ar74k.jpg" alt="黑人问号脸"></p>
<p>后来发现旧项目最低支持2.3以上，所以只能用别的办法了，因此写下此文，记录一下解决办法。</p>
<h2 id="解决之道"><a href="#解决之道" class="headerlink" title="解决之道"></a>解决之道</h2><h3 id="关键类-Instrumentation"><a href="#关键类-Instrumentation" class="headerlink" title="关键类 Instrumentation"></a>关键类 Instrumentation</h3><p>Instrumentation这个类平时开发的时候可能接触的比较少，但如果弄过Android组件单元测试的话应该会接触过。这个类很强大，比如通过这个类我们可以在Activity创建之前做一些我们自己的事情，比如拦截掉启动的Activity，换成另外一个Activity，再比如获取Activity的生命周期。怎么获取的Activity生命周期？在Instrumentation类中有callActivityOnCreate、callActivityOnResume等一些生命周期的方法。既然有生命周期的这些方法，那我们只要Hook Instrumentation这个类，就可以实现Activity生命周期的监听。那怎么Hook呢，用反射啊。</p>
<h3 id="实现方法"><a href="#实现方法" class="headerlink" title="实现方法"></a>实现方法</h3><h4 id="0、首先先定义一个MyInstrumentation继承自Instrumentation，重写callActivityOnCreate、callActivityOnResume等Activity生命周期的方法"><a href="#0、首先先定义一个MyInstrumentation继承自Instrumentation，重写callActivityOnCreate、callActivityOnResume等Activity生命周期的方法" class="headerlink" title="0、首先先定义一个MyInstrumentation继承自Instrumentation，重写callActivityOnCreate、callActivityOnResume等Activity生命周期的方法"></a>0、首先先定义一个MyInstrumentation继承自Instrumentation，重写callActivityOnCreate、callActivityOnResume等Activity生命周期的方法</h4><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInstrumentation</span> <span class="keyword">extends</span> <span class="title">Instrumentation</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle icicle)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.callActivityOnCreate(activity, icicle);</div><div class="line">		ActivityLifeManager.getInstance().onActivityCreated(activity, icicle);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnPause</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.callActivityOnPause(activity);</div><div class="line">		ActivityLifeManager.getInstance().onActivityPaused(activity);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnDestroy</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.callActivityOnDestroy(activity);</div><div class="line">		ActivityLifeManager.getInstance().onActivityDestroyed(activity);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnResume</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.callActivityOnResume(activity);</div><div class="line">		ActivityLifeManager.getInstance().onActivityResumed(activity);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnStart</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.callActivityOnStart(activity);</div><div class="line">		ActivityLifeManager.getInstance().onActivityStarted(activity);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnStop</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.callActivityOnStop(activity);</div><div class="line">		ActivityLifeManager.getInstance().onActivityStoped(activity);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注：ActivityLifeManager是自己定义的一个Activity生命周期管理类，方便管理4.0以上和4.0以下两种Activity生命周期监听方式</p>
<h4 id="1、然后将我们自己定义的MyInstrumentation利用反射将系统原本的Instrumentation替换掉"><a href="#1、然后将我们自己定义的MyInstrumentation利用反射将系统原本的Instrumentation替换掉" class="headerlink" title="1、然后将我们自己定义的MyInstrumentation利用反射将系统原本的Instrumentation替换掉"></a>1、然后将我们自己定义的MyInstrumentation利用反射将系统原本的Instrumentation替换掉</h4><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 替换系统默认的Instrumentation</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">replaceInstrumentation</span><span class="params">()</span> </span>&#123;</div><div class="line">	Class&lt;?&gt; activityThreadClass;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">// 加载activity thread的class</span></div><div class="line">		activityThreadClass = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</div><div class="line"></div><div class="line">		<span class="comment">// 找到方法currentActivityThread</span></div><div class="line">		Method method = activityThreadClass</div><div class="line">				.getDeclaredMethod(<span class="string">"currentActivityThread"</span>);</div><div class="line">		<span class="comment">// 由于这个方法是静态的，所以传入Null就行了</span></div><div class="line">		Object currentActivityThread = method.invoke(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">		<span class="comment">// 把之前ActivityThread中的mInstrumentation替换成我们自己的</span></div><div class="line">		Field field = activityThreadClass</div><div class="line">				.getDeclaredField(<span class="string">"mInstrumentation"</span>);</div><div class="line">		field.setAccessible(<span class="keyword">true</span>);</div><div class="line">		MyInstrumentation mInstrumentation = <span class="keyword">new</span> MyInstrumentation();</div><div class="line">		field.set(currentActivityThread, mInstrumentation);</div><div class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此，4.0以下Activity生命周期监听难点已经解决，接下来就是整合4.0以上和4.0以下Activity生命周期监听。</p>
<h4 id="2、整合"><a href="#2、整合" class="headerlink" title="2、整合"></a>2、整合</h4><p>ActivityLifeManager管理类，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityLifeManager</span> <span class="keyword">implements</span> <span class="title">IActivityLifecycleCallbacks</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ActivityLifeManager manager;</div><div class="line">	<span class="keyword">private</span> List&lt;IActivityLifecycleCallbacks&gt; lifeChanges = <span class="keyword">new</span> ArrayList&lt;IActivityLifecycleCallbacks&gt;();</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> ActivityLifeManager <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (manager == <span class="keyword">null</span>) &#123;</div><div class="line">			manager = <span class="keyword">new</span> ActivityLifeManager();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> manager;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="title">ActivityLifeManager</span><span class="params">()</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addIActivityLifeChange</span><span class="params">(IActivityLifecycleCallbacks lis)</span> </span>&#123;</div><div class="line">		lifeChanges.add(lis);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityStarted</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span> (IActivityLifecycleCallbacks lis : lifeChanges) &#123;</div><div class="line">			lis.onActivityStarted(activity);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityResumed</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span> (IActivityLifecycleCallbacks lis : lifeChanges) &#123;</div><div class="line">			lis.onActivityResumed(activity);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPaused</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span> (IActivityLifecycleCallbacks lis : lifeChanges) &#123;</div><div class="line">			lis.onActivityPaused(activity);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityDestroyed</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span> (IActivityLifecycleCallbacks lis : lifeChanges) &#123;</div><div class="line">			lis.onActivityDestroyed(activity);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Activity activity,</span></span></div><div class="line">			Bundle savedInstanceState) &#123;</div><div class="line">		<span class="keyword">for</span> (IActivityLifecycleCallbacks lis : lifeChanges) &#123;</div><div class="line">			lis.onActivityCreated(activity, savedInstanceState);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityStoped</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span> (IActivityLifecycleCallbacks lis : lifeChanges) &#123;</div><div class="line">			lis.onActivityStoped(activity);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>IActivityLifecycleCallbacks生命周期回调接口，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IActivityLifecycleCallbacks</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Activity activity, Bundle savedInstanceState)</span></span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityStarted</span><span class="params">(Activity activity)</span></span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityResumed</span><span class="params">(Activity activity)</span></span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPaused</span><span class="params">(Activity activity)</span></span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityStoped</span><span class="params">(Activity activity)</span></span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityDestroyed</span><span class="params">(Activity activity)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MyActivityLifecycleCallbacks 4.0以上Activity生命周期回调实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActivityLifecycleCallbacks</span></span></div><div class="line">		<span class="keyword">implements</span> <span class="title">Application</span>.<span class="title">ActivityLifecycleCallbacks</span> &#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Activity activity,</span></span></div><div class="line">			Bundle savedInstanceState) &#123;</div><div class="line">		ActivityLifeManager.getInstance().onActivityCreated(activity,</div><div class="line">				savedInstanceState);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityStarted</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityResumed</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">		ActivityLifeManager.getInstance().onActivityResumed(activity);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPaused</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">		ActivityLifeManager.getInstance().onActivityPaused(activity);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityStopped</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">		ActivityLifeManager.getInstance().onActivityStoped(activity);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivitySaveInstanceState</span><span class="params">(Activity activity,</span></span></div><div class="line">			Bundle outState) &#123;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityDestroyed</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">		ActivityLifeManager.getInstance().onActivityDestroyed(activity);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>整合使用，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Application app)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.ICE_CREAM_SANDWICH) &#123;</div><div class="line">    <span class="comment">//4.0以上使用系统自带的Activity生命周期监听方式</span></div><div class="line">		app.registerActivityLifecycleCallbacks(</div><div class="line">				<span class="keyword">new</span> MyActivityLifecycleCallbacks());</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">//4.0以下，替换Instrumentation，实现Activity生命周期监听</span></div><div class="line">		replaceInstrumentation();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">//最终两种方式生命周期统一回调</span></div><div class="line">	ActivityLifeManager.getInstance()</div><div class="line">			.addIActivityLifeChange(<span class="keyword">new</span> IActivityLifecycleCallbacks() &#123;</div><div class="line"></div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityStarted</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line"></div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityResumed</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line"></div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPaused</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line"></div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityDestroyed</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line"></div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Activity activity,</span></span></div><div class="line">						Bundle savedInstanceState) &#123;</div><div class="line"></div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityStoped</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line"></div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="源码地址-ActivityLifecycle"><a href="#源码地址-ActivityLifecycle" class="headerlink" title="源码地址 ActivityLifecycle"></a>源码地址 <a href="https://github.com/SatanFu/ActivityLifecycle" target="_blank" rel="external">ActivityLifecycle</a></h3><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><img src="http://ww1.sinaimg.cn/large/8a7693bbgw1fa03x9a37lj205i057dfv.jpg" alt="卧操，牛逼，啪啪啪"></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="true">
                <source type="audio/mpeg" src="http://link.hhtjim.com/163/25706282.mp3">
            </audio>
        </div>
        <!--<div class="comment link">添加评论</div>-->
    </div>
</div>
    </div>
</div>
</body>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>



</html>